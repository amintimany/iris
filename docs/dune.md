Support for the dune build system
=================================

**NOTE:** in case of problem with the dune build, you can ask @lepigre or
@Blaisorblade for help.

The library can be built using dune by running `dune build`. Note that `dune`
needs to be installed separately with `opam install dune`, as it is currently
not part of the dependencies of the project.

Useful links:
- [dune documentation](https://dune.readthedocs.io)
- [coq zulip channel](https://coq.zulipchat.com/#narrow/stream/240550-Dune-devs-.26-users)


Editor support
--------------

Editors relying on `_CoqProject` files for their configuration are supported.
A suitable `_CoqProject` file is generated by `dune build`. Note that you must
invoke `dune` manually to make sure that the dependencies of the file you are
stepping through are up-to-date. To build a single file, you can use, e.g.,
`dune build iris/prelude/options.vo`. To build only the `iris` folder, you can
do `dune build iris`.

Alternatively, you can configure your editor to invoke `dune coq top` instead
of `coqtop`, but that is non-trivial for most editors.

### Extra `_CoqProject` flags

If file `config/local` exists, then its contents is added at the end of
the generated `_CoqProject` file. This can be useful when the library is built
together with its dependencies (e.g., the Rocq standard library, stdpp) as part
of a dune workspace build. Note that the file can be generated with a dune rule.

#### Example setup with `stdpp` in the same workspace

To build both `iris` and `stdpp` together as part of the same workspace, you
can use the following setup steps.
```sh
mkdir workspace; cd workspace
git clone git-rts@gitlab.mpi-sws.org:iris/stdpp.git
git clone git-rts@gitlab.mpi-sws.org:iris/iris.git
echo "(lang dune 3.18)" > dune-workspace
echo "(lang dune 3.18)" > dune-project
```
The above is enough to be able to build everything (excepts tests, which are
not supported). To set up editor support you need to write the following to a
`dune` file in the `workspace` directory.
```
(subdir iris
 (subdir config
  (rule
   (action
    (with-stdout-to local
     (progn
      (echo "# Paths for the built stdpp libraries.\n")
      (echo "-Q ../_build/default/stdpp/stdpp stdpp\n")
      (echo "-Q ../_build/default/stdpp/stdpp_bitvector stdpp.bitvector\n")
      (echo "-Q ../_build/default/stdpp/stdpp_unstable stdpp.unstable\n")))))))
```
This will add the necessary bindings for compiled `stdpp` files to be found
when editing `iris` source files.
